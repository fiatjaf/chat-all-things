<!doctype html>
<meta charset=utf-8>
<title>chat-cards</title>
<link href="http://code.ionicframework.com/ionicons/2.0.1/css/ionicons.min.css" rel=stylesheet>
<link href=bundle.css rel=stylesheet>
<body></body>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pouchdb/6.0.6/pouchdb.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/cuid/1.3.8/browser-cuid.min.js"></script>
<script src="/_compile/Main.elm"></script>
<script src="bundle.js"></script>
<script>
var app
try {
  app = Elm.App.fullscreen()
} catch (e) {
  var stylesheets = document.querySelectorAll('link')
  for (var i = 0; i < stylesheets.length; i++) {
    stylesheets[i].parentNode.removeChild(stylesheets[i])
  }
  runElmProgram()
}

var db = new PouchDB('main')

app.ports.updateCardContents.subscribe(function (data) {
  var id = data[0]
  var index = data[1]
  var value = data[2]
  db.get(id, function (err, card) {
    if (err) {
      console.log('failed to fetch', id, 'to update', err)
    } else {
      if (value === null) {
        if (card.contents[index]) {
          card.contents.splice(index, 1)
          db.put(card)
        }
      } else if (typeof card.contents[index] === 'undefined') {
        card.contents.push(value)
        db.put(card)
      } else if (card.contents[index] !== value) {
        card.contents[index] = value
        db.put(card)
      }
    }
  })
})

app.ports.pouchCreate.subscribe(function (doc) {
  switch (doc.type) {
    case "message":
      doc._id = "message-" + cuid()
      break
    case "card":
      doc._id = "card-" + cuid()
      break
    default: return
  }
  delete doc.type
  db.put(doc)
})
app.ports.loadCard.subscribe(function (id) {
  db.get(id, function (err, doc) {
    if (err) {
      console.log('could not get doc', id)
    } else {
      app.ports.cardLoaded.send(doc)
    }
  })
})
app.ports.scrollChat.subscribe(function () {
  setTimeout(function () {
    document.getElementById('messages').scrollTop = 99999
  }, 900)
})
app.ports.deselectText.subscribe(function () {
  setTimeout(function () {
    if (document.selection) {
      document.selection.empty()
    } else if (window.getSelection) {
      window.getSelection().removeAllRanges()
    }
  }, 30)
})

db.changes({
  live: true,
  include_docs: true,
  return_docs: false
}).on('change', function (change) {
  switch (change.doc._id.split('-')[0]) {
    case "message":
      app.ports.pouchMessages.send(change.doc)
      break
    case "card":
      app.ports.pouchCards.send(change.doc)
      break
  }
}).on('error', function (err) {
  console.log('pouchdb changes error:', err)
})

</script>
