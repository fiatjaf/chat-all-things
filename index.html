<!doctype html>
<meta charset=utf-8>
<title>chat-cards</title>
<link href=bundle.css rel=stylesheet>
<body></body>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pouchdb/6.0.6/pouchdb.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/cuid/1.3.8/browser-cuid.min.js"></script>
<script src="/_compile/Main.elm"></script>
<script src="bundle.js"></script>
<script>
var app
try {
  app = Elm.App.fullscreen()
} catch (e) {
  var stylesheet = document.querySelector('link')
  stylesheet.parentNode.removeChild(stylesheet)
  runElmProgram()
}

var db = new PouchDB('main')

app.ports.updateCardContents.subscribe(function (data) {
  var id = data[0]
  var index = data[1]
  var value = data[2]
  db.get(id, function (err, card) {
    if (err) {
      console.log('failed to fetch', id, 'to update', err)
    } else {
      if (card.contents[index] !== value) {
        card.contents[index] = value
        db.put(card)
      }
    }
  })
})
app.ports.pouchCreate.subscribe(function (doc) {
  doc._id = cuid()
  db.put(doc)
})
app.ports.loadCard.subscribe(function (id) {
  db.get(id, function (err, doc) {
    if (err) {
      console.log('could not get doc', id)
    } else {
      app.ports.cardLoaded.send(doc)
    }
  })
})

db.changes({
  live: true,
  include_docs: true,
  // since: 'now',
  return_docs: false
}).on('change', function (change) {
  switch (change.doc.type) {
    case "message":
      app.ports.pouchMessages.send(change.doc)
      break
    case "card":
      app.ports.pouchCards.send(change.doc)
      break
  }
}).on('error', function (err) {
  console.log('pouchdb changes error:', err)
})

</script>
